# -- semantic_analysis.yml --
name: Semantic Analysis

# 1. The Trigger ("on") is required at the root
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  analysis:
    name: Run Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      # Install the tool 
      - name: Install SFW
        run: go install ./cmd/sfw
      # Make BLOCKER mode reachable for PRs and check mode for pushes
      - name: Determine Mode
        id: mode
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
             echo "mode=BLOCKER" >> $GITHUB_OUTPUT
          else
             echo "mode=check" >> $GITHUB_OUTPUT
          fi
      - name: Install gVisor (runsc)
        shell: bash
        run: |
          set -e
          
          # Architecture detection for multi-platform robustness
          ARCH=$(uname -m)
          URL="https://storage.googleapis.com/gvisor/releases/release/latest/${ARCH}"
          
          echo "::notice::Downloading gVisor binaries for ${ARCH}..."
          
          # Fetch binaries and checksums
          wget -q "${URL}/runsc" "${URL}/runsc.sha512"
          wget -q "${URL}/containerd-shim-runsc-v1" "${URL}/containerd-shim-runsc-v1.sha512"
          
          # Security validation: Verify SHA512 signatures before execution
          sha512sum -c runsc.sha512
          sha512sum -c containerd-shim-runsc-v1.sha512
          
          # Cleanup metadata and elevate permissions
          rm -f *.sha512
          chmod a+rx runsc containerd-shim-runsc-v1
          
          # Move to path; /usr/local/bin is required as runsc may re-execute itself
          sudo mv runsc containerd-shim-runsc-v1 /usr/local/bin/

          # Ubuntu 24.04 AppArmor Mitigation
          # Allows runsc --rootless to create user namespaces.
          if [[ "$(uname -s)" == "Linux" ]]; then
             echo "::notice::Applying AppArmor workaround for Ubuntu 24.04..."
             sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0 || true
          fi
          
          # Verify installation
          runsc --version
      # Run semantic analysis
      - name: Run Semantic Analysis
        shell: bash
        run: |
          set -e
          MODE="${{ steps.mode.outputs.mode }}"
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            if [[ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]]; then
                BASE_SHA="HEAD^" 
            fi
          fi
          
          echo "## Semantic Analysis Report ($MODE)" >> $GITHUB_STEP_SUMMARY
          echo "Comparing HEAD vs $BASE_SHA" >> $GITHUB_STEP_SUMMARY
          echo "| File | Status | Match % |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          FAILED_REFACTOR=false
          ERROR_COUNT=0
          
          # Semantic Context
          # Use git worktree instead of isolated file extraction to preserve package integrity.
          WORKTREE_DIR=".sfw_base_$$"
          trap 'git worktree remove --force "$WORKTREE_DIR" 2>/dev/null || rm -rf "$WORKTREE_DIR"' EXIT
          
          echo "::notice::Checking out base state to $WORKTREE_DIR..."
          git worktree add --detach "$WORKTREE_DIR" "$BASE_SHA" >/dev/null
          
          # Fail-Closed Security
          if ! command -v runsc &> /dev/null; then
            echo "::error::Critical: runsc (gVisor) not found. Aborting to prevent unsafe execution."
            exit 1
          fi
          SANDBOX_OPT=""

          # Check if there are any go files changed first to avoid empty loop errors
          if git diff --name-only "$BASE_SHA" HEAD | grep -q '\.go$'; then
            
            while IFS= read -r -d '' status; do
              case "$status" in
                R*)
                   IFS= read -r -d '' old_path
                   IFS= read -r -d '' new_path
                   OLD_FILE_REF="$old_path"
                   NEW_FILE_REF="$new_path"
                   ;;
                *)
                   IFS= read -r -d '' path
                   OLD_FILE_REF="$path"
                   NEW_FILE_REF="$path"
                   ;;
              esac

              if [[ "$NEW_FILE_REF" != *.go ]] && [[ "$OLD_FILE_REF" != *.go ]]; then continue; fi

              # Determine filesystem paths
              if [ -f "$NEW_FILE_REF" ]; then
                  NEW_FILE="$NEW_FILE_REF"
              else
                  NEW_FILE="/dev/null"
              fi

              # Point to the Worktree for the old file
              OLD_FILE="$WORKTREE_DIR/$OLD_FILE_REF"
              if [ ! -f "$OLD_FILE" ]; then
                  OLD_FILE="/dev/null"
              fi

              if [[ "$NEW_FILE" == "/dev/null" ]] && [[ "$OLD_FILE" == "/dev/null" ]]; then continue; fi
              
              if ! OUTPUT=$(sfw diff $SANDBOX_OPT "$OLD_FILE" "$NEW_FILE"); then
                  echo "::error::sfw failed on $NEW_FILE_REF"
                  ERROR_COUNT=$((ERROR_COUNT + 1))
                  continue
              fi
              
              if ! echo "$OUTPUT" | jq -e . >/dev/null 2>&1; then
                  echo "::error::Invalid JSON output for $NEW_FILE_REF"
                  ERROR_COUNT=$((ERROR_COUNT + 1))
                  continue
              fi

              PCT=$(echo "$OUTPUT" | jq -r '.summary.semantic_match_pct // 0')
              MODIFIED=$(echo "$OUTPUT" | jq -r '.summary.modified // 0')
              
              if (( $(echo "$PCT < 100" | bc -l) )); then
                  STATUS_ICON=" Modified ($MODIFIED)"
                  
                  if [ "$MODE" == "BLOCKER" ]; then
                      echo "true" > /tmp/failed_refactor
                      echo "::error file=$NEW_FILE_REF::Logic change detected in safe refactor! ($PCT%)"
                  fi
              else
                  STATUS_ICON=" Preserved"
              fi
              
              echo "| \`$NEW_FILE_REF\` | $STATUS_ICON | **$PCT%** |" >> $GITHUB_STEP_SUMMARY

            done < <(git diff -z --name-status "$BASE_SHA" HEAD)
            
          else
              echo "No Go files changed." >> $GITHUB_STEP_SUMMARY
          fi

          # Fail the job if tool errors occurred during execution
          if [ $ERROR_COUNT -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo " **CI FAILED**: Tool execution failures detected." >> $GITHUB_STEP_SUMMARY
              exit 1
          fi

          if [ -f /tmp/failed_refactor ] && [ "$(cat /tmp/failed_refactor)" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo " **CI FAILED**: Logic changed in 'semantic-safe' PR." >> $GITHUB_STEP_SUMMARY
              exit 1
          fi
          exit 0